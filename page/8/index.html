<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="liujunming's personal blog."/>













  <link rel="alternate" href="/atom.xml" title="L">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.10.1" />



<link rel="canonical" href="http://liujunming.github.io/page/8/"/>



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />




  <link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css" />



<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.10.1" />



  



  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>









<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":true};
</script>

    <title> L </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">L</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/categories">
        <li class="mobile-menu-item">
          
          
            分类
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            标签
          
        </li>
      </a>
    
      <a href="/links">
        <li class="mobile-menu-item">
          
          
            Links
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">L</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            
            
              分类
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/links">
            
            
              Links
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <section id="posts" class="posts">
    
      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/06/25/Linux内核读文件过程/">Linux内核读文件过程</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-06-25
        </span>
        
          <span class="post-category">
            
              <a href="/categories/文件系统/">文件系统</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>本篇博客使用的内核版本为<a href="http://elixir.free-electrons.com/linux/v3.12.73/source" target="_blank" rel="noopener">linux 3.12.73</a>。</p>
<h2 id="Linux内核读文件过程"><a href="#Linux内核读文件过程" class="headerlink" title="Linux内核读文件过程"></a>Linux内核读文件过程</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>用户程序想要访问IO设备需要调用操作系统提供的接口,即系统调用.当在用户程序中调用一个read操作时,系统先保存好read操作的参数,然后调用int 80命令(也可能是sysenter)进入内核空间,在内核空间中,读操作的逻辑由sys_read函数实现.</p>
<p>在讲sys_read的实现过程之前,我们先来看看read操作在内核空间需要经历的层次结构.从图中可以看出,read操作首先经过虚拟文件系统层(vfs), 接下来是具体的文件系统层,Page cache层,通用块层(generic block layer),I/O调度层(I/O scheduler layer),块设备驱动层(block device driver layer),最后是块物理设备层(block device layer).</p>
<p><img src="/images/2017/6/3.png" alt=""></p>
<ul>
<li>虚拟文件系统层:该层屏蔽了下层的具体操作,为上层提供统一的接口,如vfs_read,vfs_write等.vfs_read,vfs_write通过调用下层具体文件系统的接口来实现相应的功能.</li>
<li>具体文件系统层:该层针对每一类文件系统都有相应的操作和实现了,包含了具体文件系统的处理逻辑.</li>
<li>page cache层:该层缓存了从块设备中获取的数据.引入该层的目的是避免频繁的块设备访问,如果在page cache中已经缓存了I/O请求的数据,则可以将数据直接返回,无需访问块设备.</li>
<li>通用块层:接收上层的I/O请求,并最终发出I/O请求.该层向上层屏蔽了下层设备的特性.</li>
<li>I/O调度层:   接收通用块层发出的 IO 请求，缓存请求并试图合并相邻的请求（如果这两个请求的数据在磁盘上是相邻的）。并根据设置好的调度算法，回调驱动层提供的请求处理函数，以处理具体的 IO 请求</li>
<li>块设备驱动层:从上层取出请求,并根据参数,操作具体的设备.</li>
<li>块设备层:真正的物理设备.</li>
</ul>
<p>了解了内核层次的结构,让我们来看一下read操作的代码实现.</p>
<p>先给出函数调用图：<br><img src="/images/2017/6/5.png" alt=""></p>
<h3 id="sys-read"><a href="#sys-read" class="headerlink" title="sys_read()"></a>sys_read()</h3><p>sys_read函数声明在<a href="http://elixir.free-electrons.com/linux/v3.12.73/source/include/linux/syscalls.h#L537" target="_blank" rel="noopener">include/linux/syscalls.h</a>文件中,<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">asmlinkage <span class="keyword">long</span> <span class="title">sys_read</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> fd, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> count)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>其函数实现在<a href="http://elixir.free-electrons.com/linux/v3.12.73/source/fs/read_write.c#L499" target="_blank" rel="noopener">fs/read write.c</a>文件中:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(read, <span class="keyword">unsigned</span> <span class="keyword">int</span>, fd, <span class="keyword">char</span> __user *, buf, <span class="keyword">size_t</span>, count)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span> = <span class="title">fdget</span>(<span class="title">fd</span>);</span></span><br><span class="line">	<span class="keyword">ssize_t</span> ret = -EBADF;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (f.file) &#123;</span><br><span class="line">		<span class="keyword">loff_t</span> pos = file_pos_read(f.file);</span><br><span class="line">		ret = vfs_read(f.file, buf, count, &amp;pos);<span class="comment">//调用vfs layer中的read操作</span></span><br><span class="line">		<span class="keyword">if</span> (ret &gt;= <span class="number">0</span>)</span><br><span class="line">			file_pos_write(f.file, pos);<span class="comment">//设置当前文件的位置 </span></span><br><span class="line">		fdput(f);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="vfs-read"><a href="#vfs-read" class="headerlink" title="vfs_read()"></a>vfs_read()</h3><p> vfs_read函数属于vfs layer,定义在<a href="http://elixir.free-electrons.com/linux/v3.12.73/source/fs/read_write.c#L381" target="_blank" rel="noopener">fs/read_write.c</a>, 其主要功能是调用具体文件系统中对应的read操作,如果具体文件系统没有提供read操作,则使用默认的do_sync_read函数.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> vfs_read(struct file *file, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *pos)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">ssize_t</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!(file-&gt;f_mode &amp; FMODE_READ))</span><br><span class="line">		<span class="keyword">return</span> -EBADF;</span><br><span class="line">	<span class="keyword">if</span> (!file-&gt;f_op || (!file-&gt;f_op-&gt;read &amp;&amp; !file-&gt;f_op-&gt;aio_read))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!access_ok(VERIFY_WRITE, buf, count)))</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">	ret = rw_verify_area(READ, file, pos, count);</span><br><span class="line">	<span class="keyword">if</span> (ret &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">		count = ret;</span><br><span class="line">		<span class="keyword">if</span> (file-&gt;f_op-&gt;read)</span><br><span class="line">			ret = file-&gt;f_op-&gt;read(file, buf, count, pos);<span class="comment">//该函数由具体的文件系统指定</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			ret = do_sync_read(file, buf, count, pos);<span class="comment">//内核默认的读文件操作</span></span><br><span class="line">		<span class="keyword">if</span> (ret &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			fsnotify_access(file);</span><br><span class="line">			add_rchar(current, ret);</span><br><span class="line">		&#125;</span><br><span class="line">		inc_syscr(current);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该函数的的4个参数；file是已打开文件的file结构，该结构是由fd而来；buf是用户空间的缓冲区，就是内核将读取到的数据拷贝到这里；count是将要读取的字节数；pos是文件当前读写位置。</p>
<h3 id="do-sync-read"><a href="#do-sync-read" class="headerlink" title="do_sync_read()"></a>do_sync_read()</h3><p>file-&gt;f_op的类型为struct file_operations, 该类型定义了一系列涉及文件操作的函数指针,针对不同的文件系统,这些函数指针指向不同的实现.以ext4 文件系统为例子,该数据结构的初始化在<a href="http://elixir.free-electrons.com/linux/v3.12.73/source/fs/ext4/file.c#L593" target="_blank" rel="noopener">fs/ext4/file.c</a>,从该初始化可以知道,ext4的read操作调用了内核自带的do_sync_read()函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">ext4_file_operations</span> = &#123;</span></span><br><span class="line">	.llseek		= ext4_llseek,</span><br><span class="line">	.read		= do_sync_read,</span><br><span class="line">	.write		= do_sync_write,</span><br><span class="line">	.aio_read	= generic_file_aio_read,</span><br><span class="line">	.aio_write	= ext4_file_write,</span><br><span class="line">	.unlocked_ioctl = ext4_ioctl,</span><br><span class="line">#ifdef CONFIG_COMPAT</span><br><span class="line">	.compat_ioctl	= ext4_compat_ioctl,</span><br><span class="line">#endif</span><br><span class="line">	.mmap		= ext4_file_mmap,</span><br><span class="line">	.open		= ext4_file_open,</span><br><span class="line">	.release	= ext4_release_file,</span><br><span class="line">	.fsync		= ext4_sync_file,</span><br><span class="line">	.splice_read	= generic_file_splice_read,</span><br><span class="line">	.splice_write	= generic_file_splice_write,</span><br><span class="line">	.fallocate	= ext4_fallocate,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>do_sync_read()函数定义<a href="http://elixir.free-electrons.com/linux/v3.12.73/source/fs/read_write.c#L362" target="_blank" rel="noopener">fs/read_write.c</a>中,<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> do_sync_read(struct file *filp, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *ppos)  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> = &#123;</span> .iov_base = buf, .iov_len = len &#125;;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kiocb</span> <span class="title">kiocb</span>;</span>  </span><br><span class="line">    <span class="keyword">ssize_t</span> ret;  </span><br><span class="line">  </span><br><span class="line">    init_sync_kiocb(&amp;kiocb, filp);<span class="comment">//初始化kiocb,描述符kiocb是用来记录I/O操作的完成状态  </span></span><br><span class="line">    kiocb.ki_pos = *ppos;  </span><br><span class="line">    kiocb.ki_left = len;  </span><br><span class="line">    kiocb.ki_nbytes = len;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;  </span><br><span class="line">        ret = filp-&gt;f_op-&gt;aio_read(&amp;kiocb, &amp;iov, <span class="number">1</span>, kiocb.ki_pos);<span class="comment">//调用真正做读操作的函数,ext4文件系统在fs/ext4/file.c中配置  </span></span><br><span class="line">        <span class="keyword">if</span> (ret != -EIOCBRETRY)  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        wait_on_retry_sync_kiocb(&amp;kiocb);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (-EIOCBQUEUED == ret)  </span><br><span class="line">        ret = wait_on_sync_kiocb(&amp;kiocb);  </span><br><span class="line">    *ppos = kiocb.ki_pos;  </span><br><span class="line">    <span class="keyword">return</span> ret;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="generic-file-aio-read"><a href="#generic-file-aio-read" class="headerlink" title="generic_file_aio_read()"></a>generic_file_aio_read()</h3><p>在ext4文件系统中filp-&gt;f_op-&gt;aio_read函数指针指向generic_file_aio_read, 该函数定义于<a href="http://elixir.free-electrons.com/linux/v3.12.73/source/mm/filemap.c#L1624" target="_blank" rel="noopener">mm/filemap.c</a>文件中,该函数有两个执行路径,如果是以O_DIRECT方式打开文件,则读操作跳过page cache直接去读取磁盘,否则调用do_generic_file_read函数尝试从page cache中获取所需的数据.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span>  </span><br><span class="line">generic_file_aio_read(struct kiocb *iocb, <span class="keyword">const</span> struct iovec *iov,  </span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> nr_segs, <span class="keyword">loff_t</span> pos)  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span> = <span class="title">iocb</span>-&gt;<span class="title">ki_filp</span>;</span>  </span><br><span class="line">    <span class="keyword">ssize_t</span> retval;  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> seg = <span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">size_t</span> count;  </span><br><span class="line">    <span class="keyword">loff_t</span> *ppos = &amp;iocb-&gt;ki_pos;  </span><br><span class="line">  </span><br><span class="line">    count = <span class="number">0</span>;  </span><br><span class="line">    retval = generic_segment_checks(iov, &amp;nr_segs, &amp;count, VERIFY_WRITE);  </span><br><span class="line">    <span class="keyword">if</span> (retval)  </span><br><span class="line">        <span class="keyword">return</span> retval;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/* coalesce the iovecs and go direct-to-BIO for O_DIRECT */</span>  </span><br><span class="line">    <span class="keyword">if</span> (filp-&gt;f_flags &amp; O_DIRECT) &#123;  </span><br><span class="line">        <span class="keyword">loff_t</span> size;  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> *<span class="title">mapping</span>;</span>  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span>;</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">timex</span> <span class="title">txc</span>;</span>  </span><br><span class="line">        do_gettimeofday(&amp;(txc.time));  </span><br><span class="line">  </span><br><span class="line">        mapping = filp-&gt;f_mapping;  </span><br><span class="line">        inode = mapping-&gt;host;  </span><br><span class="line">        <span class="keyword">if</span> (!count)  </span><br><span class="line">            <span class="keyword">goto</span> out; <span class="comment">/* skip atime */</span>  </span><br><span class="line">        size = i_size_read(inode);  </span><br><span class="line">        <span class="keyword">if</span> (pos &lt; size) &#123;  </span><br><span class="line">            retval = filemap_write_and_wait_range(mapping, pos,  </span><br><span class="line">                    pos + iov_length(iov, nr_segs) - <span class="number">1</span>);  </span><br><span class="line">            <span class="keyword">if</span> (!retval) &#123;  </span><br><span class="line">                retval = mapping-&gt;a_ops-&gt;direct_IO(READ, iocb,  </span><br><span class="line">                            iov, pos, nr_segs);  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">if</span> (retval &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">                *ppos = pos + retval;  </span><br><span class="line">                count -= retval;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">/* </span></span><br><span class="line"><span class="comment">             * Btrfs can have a short DIO read if we encounter </span></span><br><span class="line"><span class="comment">             * compressed extents, so if there was an error, or if </span></span><br><span class="line"><span class="comment">             * we've already read everything we wanted to, or if </span></span><br><span class="line"><span class="comment">             * there was a short read because we hit EOF, go ahead </span></span><br><span class="line"><span class="comment">             * and return.  Otherwise fallthrough to buffered io for </span></span><br><span class="line"><span class="comment">             * the rest of the read. </span></span><br><span class="line"><span class="comment">             */</span>  </span><br><span class="line">            <span class="keyword">if</span> (retval &lt; <span class="number">0</span> || !count || *ppos &gt;= size) &#123;  </span><br><span class="line">                file_accessed(filp);  </span><br><span class="line">                <span class="keyword">goto</span> out;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    count = retval;  </span><br><span class="line">    <span class="keyword">for</span> (seg = <span class="number">0</span>; seg &lt; nr_segs; seg++) &#123;  </span><br><span class="line">        <span class="keyword">read_descriptor_t</span> desc;  </span><br><span class="line">        <span class="keyword">loff_t</span> offset = <span class="number">0</span>;  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">/* </span></span><br><span class="line"><span class="comment">         * If we did a short DIO read we need to skip the section of the </span></span><br><span class="line"><span class="comment">         * iov that we've already read data into. </span></span><br><span class="line"><span class="comment">         */</span>  </span><br><span class="line">        <span class="keyword">if</span> (count) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (count &gt; iov[seg].iov_len) &#123;  </span><br><span class="line">                count -= iov[seg].iov_len;  </span><br><span class="line">                <span class="keyword">continue</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">            offset = count;  </span><br><span class="line">            count = <span class="number">0</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        desc.written = <span class="number">0</span>;  </span><br><span class="line">        desc.arg.buf = iov[seg].iov_base + offset;  </span><br><span class="line">        desc.count = iov[seg].iov_len - offset;  </span><br><span class="line">        <span class="keyword">if</span> (desc.count == <span class="number">0</span>)  </span><br><span class="line">            <span class="keyword">continue</span>;  </span><br><span class="line">        desc.error = <span class="number">0</span>;  </span><br><span class="line">        do_generic_file_read(filp, ppos, &amp;desc, file_read_actor);  </span><br><span class="line">        retval += desc.written;  </span><br><span class="line">        <span class="keyword">if</span> (desc.error) &#123;  </span><br><span class="line">            retval = retval ?: desc.error;  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span> (desc.count &gt; <span class="number">0</span>)  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">out:  </span><br><span class="line">    <span class="keyword">return</span> retval;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="do-generic-file-read"><a href="#do-generic-file-read" class="headerlink" title="do_generic_file_read()"></a>do_generic_file_read()</h3><p>do_generic_file_read定义在<a href="http://elixir.free-electrons.com/linux/v3.12.73/source/mm/filemap.c#L1314" target="_blank" rel="noopener">mm/filemap.c</a>文件中,该函数调用page cache层中相关的函数.如果所需数据存在与page cache中,并且数据不是dirty的,则从page cache中直接获取数据返回.如果数据在page cache中不存在,或者数据是dirty的,则page cache会引发读磁盘的操作.该函数的读磁盘并不是简单的只读取所需数据的所在的block,而是会有一定的预读机制来提高cache的命中率,减少磁盘访问的次数.</p>
<p><img src="/images/2017/6/4.png" alt=""></p>
<p>该函数是通用文件读例程，真正执行读操作，是通过mapping-&gt;a_ops-&gt;readpage（）来完成。</p>
<h3 id="do-mpage-readpage"><a href="#do-mpage-readpage" class="headerlink" title="do_mpage_readpage()"></a>do_mpage_readpage()</h3><p>page cache层中真正读磁盘的操作为readpage系列,readpage系列函数具体指向的函数实现在fs/ext4/inode.c文件中定义,该文件中有很多个struct address_space_operation对象来对应于不同日志机制,我们选择linux默认的ordered模式的日志机制来描述I/O的整个流程, ordered模式对应的<a href="http://elixir.free-electrons.com/linux/v3.12.73/source/fs/ext4/inode.c#L3337" target="_blank" rel="noopener">readpage</a>系列函数如下所示.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">address_space_operations</span> <span class="title">ext4_aops</span> = &#123;</span></span><br><span class="line">	.readpage		= ext4_readpage,</span><br><span class="line">	.readpages		= ext4_readpages,</span><br><span class="line">	.writepage		= ext4_writepage,</span><br><span class="line">	.writepages		= ext4_writepages,</span><br><span class="line">	.write_begin		= ext4_write_begin,</span><br><span class="line">	.write_end		= ext4_write_end,</span><br><span class="line">	.bmap			= ext4_bmap,</span><br><span class="line">	.invalidatepage		= ext4_invalidatepage,</span><br><span class="line">	.releasepage		= ext4_releasepage,</span><br><span class="line">	.direct_IO		= ext4_direct_IO,</span><br><span class="line">	.migratepage		= buffer_migrate_page,</span><br><span class="line">	.is_partially_uptodate  = block_is_partially_uptodate,</span><br><span class="line">	.error_remove_page	= generic_error_remove_page,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>为简化流程,我们选取最简单的ext4_readpage函数来说明,该函数实现位于<a href="http://elixir.free-electrons.com/linux/v3.12.73/source/fs/ext4/inode.c#L3011" target="_blank" rel="noopener">fs/ext4/inode.c</a>中,函数很简单,只是调用了mpage_readpage函数.mpage_readpage位于<a href="http://elixir.free-electrons.com/linux/v3.12.73/source/fs/mpage.c#L402" target="_blank" rel="noopener">fs/mpage.c</a>文件中,该函数生成一个IO请求,并提交给Generic block layer.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mpage_readpage</span><span class="params">(struct page *page, <span class="keyword">get_block_t</span> get_block)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bio</span> *<span class="title">bio</span> = <span class="title">NULL</span>;</span>  </span><br><span class="line">    <span class="keyword">sector_t</span> last_block_in_bio = <span class="number">0</span>;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> <span class="title">map_bh</span>;</span>  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> first_logical_block = <span class="number">0</span>;  </span><br><span class="line">  </span><br><span class="line">    map_bh.b_state = <span class="number">0</span>;  </span><br><span class="line">    map_bh.b_size = <span class="number">0</span>;  </span><br><span class="line">    bio = do_mpage_readpage(bio, page, <span class="number">1</span>, &amp;last_block_in_bio,  </span><br><span class="line">            &amp;map_bh, &amp;first_logical_block, get_block);  </span><br><span class="line">    <span class="keyword">if</span> (bio)  </span><br><span class="line">        mpage_bio_submit(READ, bio);  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Generic-block-layer-amp-amp-I-O-Scheduler"><a href="#Generic-block-layer-amp-amp-I-O-Scheduler" class="headerlink" title="Generic block layer &amp;&amp; I/O Scheduler"></a>Generic block layer &amp;&amp; I/O Scheduler</h3><p>Generic block layer会将该请求分发到具体设备的IO队列中,由I/O Scheduler去调用具体的driver接口获取所需的数据.</p>
<hr>
<p>参考资料：</p>
<ol>
<li><a href="http://blog.csdn.net/dashulu/article/details/16820281" target="_blank" rel="noopener">csdn dashulu</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-read/" target="_blank" rel="noopener">read系统调用剖析</a></li>
<li><a href="http://www.ilinuxkernel.com/files/Linux.Kernel.Read.Procedure.pdf" target="_blank" rel="noopener">Linux 内核读文件过程</a></li>
<li><a href="http://blog.csdn.net/jemmy858585/article/details/43937149" target="_blank" rel="noopener">vfs读写流程梳理</a></li>
<li><a href="http://m.blog.chinaunix.net/uid-28236237-id-4030381.html" target="_blank" rel="noopener">do_generic_file_read函数的详细分析</a></li>
</ol>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/06/25/address-space-页高速缓存/">address_space,页高速缓存</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-06-25
        </span>
        
          <span class="post-category">
            
              <a href="/categories/文件系统/">文件系统</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p><code>address_space</code>对象是文件系统中关于内存中页高速缓存的核心数据结构。这篇博客以address_space对象为切入点,分析文件系统的页高速缓存。</p>
<h3 id="1背景"><a href="#1背景" class="headerlink" title="1背景"></a>1背景</h3><p>页高速缓存,它是一种对完整的数据页进行操作的磁盘高速缓存,即把磁盘的数据块缓存在页高速缓存中。而address_space对页高速缓存进行管理。</p>
<h3 id="2页高速缓存介绍"><a href="#2页高速缓存介绍" class="headerlink" title="2页高速缓存介绍"></a>2页高速缓存介绍</h3><p>linux中几乎所有文件的读和写操作都依赖于页高速缓存。只有在O_DIRECT标志置为才会出现意外:此时,I/O数据的传送绕过了页高速缓存而使用了进程用户态地址空间的缓冲区;另外,少量的数据库软件为了采用自己的磁盘高速缓存算法而使用了O_DIRECT标志。</p>
<p>why设计页高速缓存?</p>
<ol>
<li>快速定位所有者相关数据页的位置(基树)</li>
<li>区分不同所有者页的不同读写操作,如普通文件、块设备文件、交换区文件读一个数据页必须使用不同的方式实现,故内核根据页的不同所有者进行不同的操作。</li>
</ol>
<h3 id="3address-space对象"><a href="#3address-space对象" class="headerlink" title="3address_space对象"></a>3address_space对象</h3><p>每一个所有者(可以理解为一个具体的文件,一个inode指向的文件)对应着一个address_space对象,页高速缓存的多个页可能属于一个所有者,从而可以链接到一个address_space对象。那么一个页(page)怎么和一个address_space产生关联的呢?</p>
<p>每个页描述符都包括把页链接到页高速缓存的两个字段mapping和index。mapping指向拥有该页的索引节点的address_space对象(inode结构有一个i_mapping指向对应address_space对象),index字段表示在所有者的地址空间中以页大小为单位的偏移量,也就是在所有者的磁盘映像中页中数据的位置。</p>
<p>address_space中有一个host字段,该字段指向其所属的inode,也就是address_space中的host字段 与 对应inode中的 i_data字段形成互相指向的关系。若为普通文件,那么inode结点和address_space结构的相应指针的指向关系如下图:</p>
<p><img src="/images/2017/6/1.jpg" alt=""></p>
<h3 id="4基树"><a href="#4基树" class="headerlink" title="4基树"></a>4基树</h3><p>linux支持TB级的文件,ext4甚至支持到了PB级文件,访问大文件时,高速缓存中存在着有关该文件太多的页,故设计了基树这个结构来加快查找。一个address_space对象对应一个基树。</p>
<p>address_space中有一个字段(page_tree)指向是基树的根(radix_tree_root)。基树根中的rnode指向基树的最高层节点(radix_tree_node),基树节点都是radix_tree_node结构,节点中存放的都是指针,叶子节点的指针指向页描述符,上层节点指向存放其他节点的指针。一般一个radix_tree_node最多可以有64个指针,字段count表示该radix_tree_node已用节点数。</p>
<p>怎么快速找到所需页在基树中的位置呢?</p>
<p>回顾本科所学知识:分页系统如何利用页表实现线性地址到物理地址的转换?线性地址的最高20位分为两个10为的字段:第一个字段是页目录的偏移,第二个字段是页目录所指向也表的偏移。</p>
<p>基树中使用类似的方法。页索引相当于线性地址,不过页索引中要考虑的字段的数量依赖于基树的深度。如果基树的深度为1,就只能表示从0~63范围的索引,因此页索引的低6位被解释为slots数组的下标,每个下标对应第一层的一个节点。如果基树的深度为2,就可以表示从0~4095范围的索引,页索引的低12位分成两个6位的字段,高位的字段用于表示第一层节点数组的下标,而低位的字段用于表示第二层数组的下标。</p>
<p><img src="/images/2017/6/2.jpg" alt=""></p>
<hr>
<p>参考资料：</p>
<ol>
<li>《深入理解linux内核》</li>
<li><a href="http://sundayhut.is-programmer.com/posts/62440.html" target="_blank" rel="noopener">sundayhut</a></li>
</ol>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/05/20/设计模式-访问者模式/">设计模式:访问者模式</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-05-20
        </span>
        
          <span class="post-category">
            
              <a href="/categories/软件工程/">软件工程</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h2 id="Visitor-Design-Pattern"><a href="#Visitor-Design-Pattern" class="headerlink" title="Visitor Design Pattern"></a>Visitor Design Pattern</h2><p>Visitor Design Pattern is one of the behavioral design pattern.</p>
<p>Visitor pattern is used when we have to perform an operation on a group of similar kind of Objects. With the help of visitor pattern, we can move the operational logic from the objects to another class.</p>
<p>For example, think of a Shopping cart where we can add different type of items (Elements). When we click on checkout button, it calculates the total amount to be paid. Now we can have the calculation logic in item classes or we can move out this logic to another class using visitor pattern. Let’s implement this in our example of visitor pattern.</p>
<h3 id="Visitor-Design-Pattern-Java-Example"><a href="#Visitor-Design-Pattern-Java-Example" class="headerlink" title="Visitor Design Pattern Java Example"></a>Visitor Design Pattern Java Example</h3><p>To implement visitor pattern, first of all we will create different type of items (Elements) to be used in shopping cart.</p>
<p><code>ItemElement.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.visitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ItemElement</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">accept</span><span class="params">(ShoppingCartVisitor visitor)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Notice that accept method takes Visitor argument. We can have some other methods also specific for items but for simplicity I am not going into that much detail and focusing on visitor pattern only.</p>
<p>Let’s create some concrete classes for different types of items.</p>
<p><code>Book.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.visitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> <span class="keyword">implements</span> <span class="title">ItemElement</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> price;</span><br><span class="line">	<span class="keyword">private</span> String isbnNumber;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Book</span><span class="params">(<span class="keyword">int</span> cost, String isbn)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.price=cost;</span><br><span class="line">		<span class="keyword">this</span>.isbnNumber=isbn;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> price;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getIsbnNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> isbnNumber;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">accept</span><span class="params">(ShoppingCartVisitor visitor)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> visitor.visit(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Fruit.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.visitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fruit</span> <span class="keyword">implements</span> <span class="title">ItemElement</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> pricePerKg;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> weight;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Fruit</span><span class="params">(<span class="keyword">int</span> priceKg, <span class="keyword">int</span> wt, String nm)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.pricePerKg=priceKg;</span><br><span class="line">		<span class="keyword">this</span>.weight=wt;</span><br><span class="line">		<span class="keyword">this</span>.name = nm;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPricePerKg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> pricePerKg;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getWeight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> weight;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">accept</span><span class="params">(ShoppingCartVisitor visitor)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> visitor.visit(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Notice the implementation of accept() method in concrete classes, its calling visit() method of Visitor and passing itself as argument.</p>
<p>We have visit() method for different type of items in Visitor interface that will be implemented by concrete visitor class.</p>
<p><code>ShoppingCartVisitor.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.visitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ShoppingCartVisitor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">visit</span><span class="params">(Book book)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">visit</span><span class="params">(Fruit fruit)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Now we will implement visitor interface and every item will have it’s own logic to calculate the cost.</p>
<p><code>ShoppingCartVisitorImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.visitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShoppingCartVisitorImpl</span> <span class="keyword">implements</span> <span class="title">ShoppingCartVisitor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">visit</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> cost=<span class="number">0</span>;</span><br><span class="line">		<span class="comment">//apply 5$ discount if book price is greater than 50</span></span><br><span class="line">		<span class="keyword">if</span>(book.getPrice() &gt; <span class="number">50</span>)&#123;</span><br><span class="line">			cost = book.getPrice()-<span class="number">5</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span> cost = book.getPrice();</span><br><span class="line">		System.out.println(<span class="string">"Book ISBN::"</span>+book.getIsbnNumber() + <span class="string">" cost ="</span>+cost);</span><br><span class="line">		<span class="keyword">return</span> cost;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">visit</span><span class="params">(Fruit fruit)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> cost = fruit.getPricePerKg()*fruit.getWeight();</span><br><span class="line">		System.out.println(fruit.getName() + <span class="string">" cost = "</span>+cost);</span><br><span class="line">		<span class="keyword">return</span> cost;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Lets see how we can use visitor pattern example in client applications.</p>
<p><code>ShoppingCartClient.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.visitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShoppingCartClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		ItemElement[] items = <span class="keyword">new</span> ItemElement[]&#123;<span class="keyword">new</span> Book(<span class="number">20</span>, <span class="string">"1234"</span>),<span class="keyword">new</span> Book(<span class="number">100</span>, <span class="string">"5678"</span>),</span><br><span class="line">				<span class="keyword">new</span> Fruit(<span class="number">10</span>, <span class="number">2</span>, <span class="string">"Banana"</span>), <span class="keyword">new</span> Fruit(<span class="number">5</span>, <span class="number">5</span>, <span class="string">"Apple"</span>)&#125;;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">int</span> total = calculatePrice(items);</span><br><span class="line">		System.out.println(<span class="string">"Total Cost = "</span>+total);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">calculatePrice</span><span class="params">(ItemElement[] items)</span> </span>&#123;</span><br><span class="line">		ShoppingCartVisitor visitor = <span class="keyword">new</span> ShoppingCartVisitorImpl();</span><br><span class="line">		<span class="keyword">int</span> sum=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span>(ItemElement item : items)&#123;</span><br><span class="line">			sum = sum + item.accept(visitor);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> sum;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>When we run above visitor pattern client program, we get following output.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Book ISBN::1234 cost =20</span><br><span class="line">Book ISBN::5678 cost =95</span><br><span class="line">Banana cost = 20</span><br><span class="line">Apple cost = 25</span><br><span class="line">Total Cost = 160</span><br></pre></td></tr></table></figure></p>
<p>Notice that implementation if accept() method in all the items are same but it can be different, for example there can be logic to check if item is free then don’t call the visit() method at all.</p>
<h3 id="Visitor-Design-Pattern-Class-Diagram"><a href="#Visitor-Design-Pattern-Class-Diagram" class="headerlink" title="Visitor Design Pattern Class Diagram"></a>Visitor Design Pattern Class Diagram</h3><p>Class diagram for our visitor design pattern implementation is:</p>
<p><img src="/images/2017/5/1.png" alt="这里写图片描述"></p>
<h3 id="Visitor-Pattern-Benefits"><a href="#Visitor-Pattern-Benefits" class="headerlink" title="Visitor Pattern Benefits"></a>Visitor Pattern Benefits</h3><p>The benefit of this pattern is that if the logic of operation changes, then we need to make change only in the visitor implementation rather than doing it in all the item classes.</p>
<p>Another benefit is that adding a new item to the system is easy, it will require change only in visitor interface and implementation and existing item classes will not be affected.</p>
<h3 id="Visitor-Pattern-Limitations"><a href="#Visitor-Pattern-Limitations" class="headerlink" title="Visitor Pattern Limitations"></a>Visitor Pattern Limitations</h3><p>The drawback of visitor pattern is that we should know the return type of visit() methods at the time of designing otherwise we will have to change the interface and all of its implementations. Another drawback is that if there are too many implementations of visitor interface, it makes it hard to extend.</p>
<hr>
<p>转载：<br><a href="http://www.journaldev.com/1769/visitor-design-pattern-java" target="_blank" rel="noopener">journaldev</a></p>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/05/18/设计模式-模板方法模式/">设计模式:模板方法模式</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-05-18
        </span>
        
          <span class="post-category">
            
              <a href="/categories/软件工程/">软件工程</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h2 id="Template-Method-Design-Pattern-in-Java"><a href="#Template-Method-Design-Pattern-in-Java" class="headerlink" title="Template Method Design Pattern in Java"></a>Template Method Design Pattern in Java</h2><p>Template Method is a <strong>behavioral design pattern</strong>. Template Method design pattern is used to create a method stub and deferring some of the steps of implementation to the subclasses.</p>
<h3 id="Template-Method-Design-Pattern"><a href="#Template-Method-Design-Pattern" class="headerlink" title="Template Method Design Pattern"></a>Template Method Design Pattern</h3><p>Template method defines the steps to execute an algorithm and it can provide default implementation that might be common for all or some of the subclasses.</p>
<p>Let’s understand this pattern with an example, suppose we want to provide an algorithm to build a house. The steps need to be performed to build a house are – building foundation, building pillars, building walls and windows. The important point is that the we can’t change the order of execution because we can’t build windows before building the foundation. So in this case we can create a template method that will use different methods to build the house.</p>
<p>Now building the foundation for a house is same for all type of houses, whether its a wooden house or a glass house. So we can provide base implementation for this, if subclasses want to override this method, they can but mostly it’s common for all the types of houses.</p>
<p>To make sure that subclasses don’t override the template method, we should make it final.</p>
<h3 id="Template-Method-Abstract-Class"><a href="#Template-Method-Abstract-Class" class="headerlink" title="Template Method Abstract Class"></a>Template Method Abstract Class</h3><p>Since we want some of the methods to be implemented by subclasses, we have to make our base class as <em>abstract class</em>.</p>
<p><code>HouseTemplate.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.template;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">HouseTemplate</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//template method, final so subclasses can't override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">buildHouse</span><span class="params">()</span></span>&#123;</span><br><span class="line">		buildFoundation();</span><br><span class="line">		buildPillars();</span><br><span class="line">		buildWalls();</span><br><span class="line">		buildWindows();</span><br><span class="line">		System.out.println(<span class="string">"House is built."</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//default implementation</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildWindows</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"Building Glass Windows"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//methods to be implemented by subclasses</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">buildWalls</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">buildPillars</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildFoundation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"Building foundation with cement,iron rods and sand"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>buildHouse()</code> is the template method and defines the order of execution for performing several steps.</p>
<h3 id="Template-Method-Concrete-Classes"><a href="#Template-Method-Concrete-Classes" class="headerlink" title="Template Method Concrete Classes"></a>Template Method Concrete Classes</h3><p>We can have different type of houses, such as Wooden House and Glass House.</p>
<p><code>WoodenHouse.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.template;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WoodenHouse</span> <span class="keyword">extends</span> <span class="title">HouseTemplate</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildWalls</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"Building Wooden Walls"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildPillars</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"Building Pillars with Wood coating"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>We could have overridden other methods also, but for simplicity I am not doing that.</p>
<p><code>GlassHouse.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.template;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlassHouse</span> <span class="keyword">extends</span> <span class="title">HouseTemplate</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildWalls</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"Building Glass Walls"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildPillars</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"Building Pillars with glass coating"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Template-Method-Design-Pattern-Client"><a href="#Template-Method-Design-Pattern-Client" class="headerlink" title="Template Method Design Pattern Client"></a>Template Method Design Pattern Client</h3><p>Let’s test our template method pattern example with a test program.</p>
<p><code>HousingClient.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.template;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HousingClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		HouseTemplate houseType = <span class="keyword">new</span> WoodenHouse();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//using template method</span></span><br><span class="line">		houseType.buildHouse();</span><br><span class="line">		System.out.println(<span class="string">"************"</span>);</span><br><span class="line">		</span><br><span class="line">		houseType = <span class="keyword">new</span> GlassHouse();</span><br><span class="line">		</span><br><span class="line">		houseType.buildHouse();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Notice that client is invoking the template method of base class and depending of implementation of different steps, it’s using some of the methods from base class and some of them from subclass.</p>
<p>Output of the above program is:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Building foundation with cement,iron rods and sand</span><br><span class="line">Building Pillars with Wood coating</span><br><span class="line">Building Wooden Walls</span><br><span class="line">Building Glass Windows</span><br><span class="line">House is built.</span><br><span class="line">************</span><br><span class="line">Building foundation with cement,iron rods and sand</span><br><span class="line">Building Pillars with glass coating</span><br><span class="line">Building Glass Walls</span><br><span class="line">Building Glass Windows</span><br><span class="line">House is built.</span><br></pre></td></tr></table></figure></p>
<h3 id="Template-Method-Class-Diagram"><a href="#Template-Method-Class-Diagram" class="headerlink" title="Template Method Class Diagram"></a>Template Method Class Diagram</h3><p><img src="/images/2017/5/template-method-pattern.png" alt="这里写图片描述"></p>
<h3 id="Template-Method-Design-Pattern-Important-Points"><a href="#Template-Method-Design-Pattern-Important-Points" class="headerlink" title="Template Method Design Pattern Important Points"></a>Template Method Design Pattern Important Points</h3><ol>
<li>Template method should consists of certain steps whose order is fixed and for some of the methods, implementation differs from base class to subclass. Template method should be final.</li>
<li>Most of the times, subclasses calls methods from super class but in template pattern, superclass template method calls methods from subclasses, this is known as <a href="http://en.wikipedia.org/wiki/Hollywood_principle" target="_blank" rel="noopener">Hollywood Principle</a> – “don’t call us, we’ll call you.”.</li>
<li>Methods in base class with default implementation are referred as <strong>Hooks</strong> and they are intended to be overridden by subclasses, if you want some of the methods to be not overridden, you can make them final, for example in our case we can make buildFoundation() method final because if we don’t want subclasses to override it.</li>
</ol>
<hr>
<p>转载：<br><a href="http://www.journaldev.com/1763/template-method-design-pattern-in-java" target="_blank" rel="noopener">journaldev</a></p>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/05/17/设计模式-策略模式/">设计模式:策略模式</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-05-17
        </span>
        
          <span class="post-category">
            
              <a href="/categories/软件工程/">软件工程</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h2 id="Strategy-Design-Pattern-in-Java-–-Example-Tutorial"><a href="#Strategy-Design-Pattern-in-Java-–-Example-Tutorial" class="headerlink" title="Strategy Design Pattern in Java – Example Tutorial"></a>Strategy Design Pattern in Java – Example Tutorial</h2><p>Strategy design pattern is one of the <strong>behavioral design pattern</strong>. Strategy pattern is used when we have multiple algorithm for a specific task and client decides the actual implementation to be used at runtime.</p>
<h3 id="Strategy-Pattern"><a href="#Strategy-Pattern" class="headerlink" title="Strategy Pattern"></a>Strategy Pattern</h3><p>Strategy pattern is also known as <strong>Policy Pattern</strong>. We define multiple algorithms and let client application pass the algorithm to be used as a parameter.</p>
<p>One of the best example of strategy pattern is <code>Collections.sort()</code> method that takes Comparator parameter. Based on the different implementations of Comparator interfaces, the Objects are getting sorted in different ways.</p>
<p>For our example, we will try to implement a simple Shopping Cart where we have two payment strategies – using Credit Card or using PayPal.</p>
<p>First of all we will create the interface for our strategy pattern example, in our case to pay the amount passed as argument.</p>
<p><code>PaymentStrategy.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.strategy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PaymentStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay</span><span class="params">(<span class="keyword">int</span> amount)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Now we will have to create concrete implementation of algorithms for payment using credit/debit card or through paypal.</p>
<p><code>CreditCardStrategy.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.strategy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreditCardStrategy</span> <span class="keyword">implements</span> <span class="title">PaymentStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> String cardNumber;</span><br><span class="line">	<span class="keyword">private</span> String cvv;</span><br><span class="line">	<span class="keyword">private</span> String dateOfExpiry;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">CreditCardStrategy</span><span class="params">(String nm, String ccNum, String cvv, String expiryDate)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.name=nm;</span><br><span class="line">		<span class="keyword">this</span>.cardNumber=ccNum;</span><br><span class="line">		<span class="keyword">this</span>.cvv=cvv;</span><br><span class="line">		<span class="keyword">this</span>.dateOfExpiry=expiryDate;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay</span><span class="params">(<span class="keyword">int</span> amount)</span> </span>&#123;</span><br><span class="line">		System.out.println(amount +<span class="string">" paid with credit/debit card"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>PaypalStrategy.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.strategy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaypalStrategy</span> <span class="keyword">implements</span> <span class="title">PaymentStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String emailId;</span><br><span class="line">	<span class="keyword">private</span> String password;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PaypalStrategy</span><span class="params">(String email, String pwd)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.emailId=email;</span><br><span class="line">		<span class="keyword">this</span>.password=pwd;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay</span><span class="params">(<span class="keyword">int</span> amount)</span> </span>&#123;</span><br><span class="line">		System.out.println(amount + <span class="string">" paid using Paypal."</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Now our strategy pattern example algorithms are ready. We can implement Shopping Cart and payment method will require input as Payment strategy.</p>
<p><code>Item.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.strategy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String upcCode;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> price;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Item</span><span class="params">(String upc, <span class="keyword">int</span> cost)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.upcCode=upc;</span><br><span class="line">		<span class="keyword">this</span>.price=cost;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getUpcCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> upcCode;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> price;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>ShoppingCart.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.text.DecimalFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShoppingCart</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//List of items</span></span><br><span class="line">	List&lt;Item&gt; items;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ShoppingCart</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.items=<span class="keyword">new</span> ArrayList&lt;Item&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addItem</span><span class="params">(Item item)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.items.add(item);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeItem</span><span class="params">(Item item)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.items.remove(item);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">calculateTotal</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span>(Item item : items)&#123;</span><br><span class="line">			sum += item.getPrice();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> sum;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay</span><span class="params">(PaymentStrategy paymentMethod)</span></span>&#123;</span><br><span class="line">		<span class="keyword">int</span> amount = calculateTotal();</span><br><span class="line">		paymentMethod.pay(amount);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Notice that payment method of shopping cart requires payment algorithm as argument and doesn’t store it anywhere as instance variable.</p>
<p>Let’s test our strategy pattern example setup with a simple program.</p>
<p><code>ShoppingCartTest.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.journaldev.design.strategy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShoppingCartTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		ShoppingCart cart = <span class="keyword">new</span> ShoppingCart();</span><br><span class="line">		</span><br><span class="line">		Item item1 = <span class="keyword">new</span> Item(<span class="string">"1234"</span>,<span class="number">10</span>);</span><br><span class="line">		Item item2 = <span class="keyword">new</span> Item(<span class="string">"5678"</span>,<span class="number">40</span>);</span><br><span class="line">		</span><br><span class="line">		cart.addItem(item1);</span><br><span class="line">		cart.addItem(item2);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//pay by paypal</span></span><br><span class="line">		cart.pay(<span class="keyword">new</span> PaypalStrategy(<span class="string">"myemail@example.com"</span>, <span class="string">"mypwd"</span>));</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//pay by credit card</span></span><br><span class="line">		cart.pay(<span class="keyword">new</span> CreditCardStrategy(<span class="string">"Pankaj Kumar"</span>, <span class="string">"1234567890123456"</span>, <span class="string">"786"</span>, <span class="string">"12/15"</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Output of above program is:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">50 paid using Paypal.</span><br><span class="line">50 paid with credit/debit card</span><br></pre></td></tr></table></figure></p>
<h3 id="Strategy-Design-Pattern-Class-Diagram"><a href="#Strategy-Design-Pattern-Class-Diagram" class="headerlink" title="Strategy Design Pattern Class Diagram"></a>Strategy Design Pattern Class Diagram</h3><p><img src="/images/2017/5/Strategy-Pattern.png" alt="这里写图片描述"></p>
<h3 id="Strategy-Design-Pattern-Important-Points"><a href="#Strategy-Design-Pattern-Important-Points" class="headerlink" title="Strategy Design Pattern Important Points"></a>Strategy Design Pattern Important Points</h3><ul>
<li>We could have used composition to create instance variable for strategies but we should avoid that as we want the specific strategy to be applied for a particular task. Same is followed in Collections.sort() and Arrays.sort() method that take comparator as argument.</li>
<li>Strategy Pattern is very similar to State Pattern. One of the difference is that Context contains state as instance variable and there can be multiple tasks whose implementation can be dependent on the state whereas in strategy pattern strategy is passed as argument to the method and context object doesn’t have any variable to store it.</li>
<li>Strategy pattern is useful when we have multiple algorithms for specific task and we want our application to be flexible to chose any of the algorithm at runtime for specific task.</li>
</ul>
<hr>
<p>转载：<br><a href="http://www.journaldev.com/1739/observer-design-pattern-in-java" target="_blank" rel="noopener">journaldev</a></p>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/05/16/设计模式-状态模式/">设计模式:状态模式</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-05-16
        </span>
        
          <span class="post-category">
            
              <a href="/categories/软件工程/">软件工程</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h2 id="状态模式"><a href="#状态模式" class="headerlink" title="状态模式"></a>状态模式</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>在状态模式（State Pattern）中，类的行为是基于它的状态改变的。这种类型的设计模式属于行为型模式。</p>
<p>在状态模式中，我们创建表示各种状态的对象和一个行为随着状态对象改变而改变的 context 对象。</p>
<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><h4 id="意图"><a href="#意图" class="headerlink" title="意图"></a>意图</h4><p>允许对象在内部状态发生改变时改变它的行为，对象看起来好像修改了它的类</p>
<h4 id="主要解决"><a href="#主要解决" class="headerlink" title="主要解决"></a>主要解决</h4><p>对象的行为依赖于它的状态（属性），并且可以根据它的状态改变而改变它的相关行为</p>
<h4 id="何时使用"><a href="#何时使用" class="headerlink" title="何时使用"></a>何时使用</h4><p>代码中包含大量与对象状态有关的条件语句</p>
<h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ol>
<li>封装了转换规则</li>
<li>枚举可能的状态，在枚举状态之前需要确定状态种类</li>
<li>将所有与某个状态有关的行为放到一个类中，并且可以方便地增加新的状态，只需要改变对象状态即可改变对象的行为</li>
<li>允许状态转换逻辑与状态对象合成一体，而不是某一个巨大的条件语句块</li>
<li>可以让多个环境对象共享一个状态对象，从而减少系统中对象的个数</li>
</ol>
<h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><ol>
<li>状态模式的使用必然会增加系统类和对象的个数 </li>
<li>状态模式的结构与实现都较为复杂，如果使用不当将导致程序结构和代码的混乱</li>
<li>状态模式对”开闭原则”的支持并不太好，对于可以切换状态的状态模式，增加新的状态类需要修改那些负责状态转换的源代码，否则无法切换到新增状态，而且修改某个状态类的行为也需修改对应类的源代码</li>
</ol>
<h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><ol>
<li>行为随状态改变而改变的场景</li>
<li>条件、分支语句的代替者</li>
</ol>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>我们将创建一个 <em>State</em> 接口和实现了 <em>State</em> 接口的实体状态类。<em>Context</em> 是一个带有某个状态的类。<br><em>StatePatternDemo</em>，我们的演示类使用 <em>Context</em> 和状态对象来演示 <em>Context</em> 在状态改变时的行为变化。</p>
<p><img src="http://www.runoob.com/wp-content/uploads/2014/08/state_pattern_uml_diagram.jpg" alt=""></p>
<h4 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤 1"></a>步骤 1</h4><p>创建一个接口。<br><em>State.java</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAction</span><span class="params">(Context context)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="步骤-2"><a href="#步骤-2" class="headerlink" title="步骤 2"></a>步骤 2</h4><p>创建实现接口的实体类。<br><em>StartState.java</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StartState</span> <span class="keyword">implements</span> <span class="title">State</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAction</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">"Player is in start state"</span>);</span><br><span class="line">      context.setState(<span class="keyword">this</span>);	</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"Start State"</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><em>StopState.java</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StopState</span> <span class="keyword">implements</span> <span class="title">State</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAction</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">"Player is in stop state"</span>);</span><br><span class="line">      context.setState(<span class="keyword">this</span>);	</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"Stop State"</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="步骤-3"><a href="#步骤-3" class="headerlink" title="步骤 3"></a>步骤 3</h4><p>创建 <em>Context</em> 类。<br><em>Context.java</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> State state;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Context</span><span class="params">()</span></span>&#123;</span><br><span class="line">      state = <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(State state)</span></span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.state = state;		</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> State <span class="title">getState</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="步骤-4"><a href="#步骤-4" class="headerlink" title="步骤 4"></a>步骤 4</h4><p>使用 <em>Context</em> 来查看当状态 <em>State</em> 改变时的行为变化。<br><em>StatePatternDemo.java</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StatePatternDemo</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      Context context = <span class="keyword">new</span> Context();</span><br><span class="line"></span><br><span class="line">      StartState startState = <span class="keyword">new</span> StartState();</span><br><span class="line">      startState.doAction(context);</span><br><span class="line"></span><br><span class="line">      System.out.println(context.getState().toString());</span><br><span class="line"></span><br><span class="line">      StopState stopState = <span class="keyword">new</span> StopState();</span><br><span class="line">      stopState.doAction(context);</span><br><span class="line"></span><br><span class="line">      System.out.println(context.getState().toString());</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="步骤-5"><a href="#步骤-5" class="headerlink" title="步骤 5"></a>步骤 5</h4><p>验证输出。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Player is in start state</span><br><span class="line">Start State</span><br><span class="line">Player is in stop state</span><br><span class="line">Stop State</span><br></pre></td></tr></table></figure></p>
<hr>
<p>参考资料：</p>
<ol>
<li><a href="http://www.runoob.com/design-pattern/state-pattern.html" target="_blank" rel="noopener">菜鸟教程</a></li>
<li><a href="http://www.journaldev.com/1751/state-design-pattern-java" target="_blank" rel="noopener">journaldev.com</a></li>
</ol>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/05/12/设计模式-观察者模式/">设计模式:观察者模式</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-05-12
        </span>
        
          <span class="post-category">
            
              <a href="/categories/软件工程/">软件工程</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h2 id="Observer-Design-Pattern-in-Java"><a href="#Observer-Design-Pattern-in-Java" class="headerlink" title="Observer Design Pattern in Java"></a>Observer Design Pattern in Java</h2><p><strong>Observer Pattern</strong> is one of the <strong>behavioral design pattern</strong>. Observer design pattern is useful when you are interested in the state of an object and want to get notified whenever there is any change. In observer pattern, the object that watch on the state of another object are called <strong>Observer</strong> and the object that is being watched is called <strong>Subject</strong>.</p>
<h3 id="Observer-Design-Pattern"><a href="#Observer-Design-Pattern" class="headerlink" title="Observer Design Pattern"></a>Observer Design Pattern</h3><p>According to GoF, observer design pattern intent is;</p>
<blockquote>
<p>Define a one-to-many dependency between objects so that when one object changes state, all its dependents are       notified and updated automatically.</p>
</blockquote>
<p><strong>Subject</strong> contains a list of observers to notify of any change in it’s state, so it should provide methods using which observers can register and unregister themselves. Subject also contain a method to notify all the observers of any change and either it can send the update while notifying the observer or it can provide another method to get the update.</p>
<p>Observer should have a method to set the object to watch and another method that will be used by Subject to notify them of any updates.</p>
<p>Java provides inbuilt platform for implementing Observer pattern through <em>java.util.Observable</em> class and <em>java.util.Observer</em> interface. However it’s not widely used because the implementation is really simple and most of the times we don’t want to end up extending a class just for implementing Observer pattern as java doesn’t provide multiple inheritance in classes.</p>
<p>Java Message Service (JMS) uses <strong>Observer design pattern</strong> along with <strong>Mediator pattern</strong> to allow applications to subscribe and publish data to other applications.</p>
<p>Model-View-Controller (MVC) frameworks also use Observer pattern where Model is the Subject and Views are observers that can register to get notified of any change to the model.</p>
<h3 id="Observer-Pattern-Java-Example"><a href="#Observer-Pattern-Java-Example" class="headerlink" title="Observer Pattern Java Example"></a>Observer Pattern Java Example</h3><p>For our observer pattern java program example, we would implement a simple topic and observers can register to this topic. Whenever any new message will be posted to the topic, all the registers observers will be notified and they can consume the message.</p>
<p>Based on the requirements of Subject, here is the base Subject interface that defines the contract methods to be implemented by any concrete subject.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.observer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//methods to register and unregister observers</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Observer obj)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregister</span><span class="params">(Observer obj)</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//method to notify observers of change</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyObservers</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//method to get updates from subject</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">getUpdate</span><span class="params">(Observer obj)</span></span>;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Next we will create contract for Observer, there will be a method to attach the Subject to the observer and another method to be used by Subject to notify of any change.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.observer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//method to update the observer, used by subject</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//attach with subject to observe</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSubject</span><span class="params">(Subject sub)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now our contract is ready, let’s proceed with the concrete implementation of our topic.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.observer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTopic</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> List&lt;Observer&gt; observers;</span><br><span class="line">	<span class="keyword">private</span> String message;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> changed;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Object MUTEX= <span class="keyword">new</span> Object();</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MyTopic</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.observers=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Observer obj)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(obj == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Null Observer"</span>);</span><br><span class="line">		<span class="keyword">synchronized</span> (MUTEX) &#123;</span><br><span class="line">		<span class="keyword">if</span>(!observers.contains(obj)) observers.add(obj);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregister</span><span class="params">(Observer obj)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">synchronized</span> (MUTEX) &#123;</span><br><span class="line">		observers.remove(obj);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyObservers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		List&lt;Observer&gt; observersLocal = <span class="keyword">null</span>;</span><br><span class="line">       </span><br><span class="line">		<span class="comment">//synchronization is used to make sure any observer</span></span><br><span class="line">        <span class="comment">//registered after message is received is not notified</span></span><br><span class="line">       </span><br><span class="line">		<span class="keyword">synchronized</span> (MUTEX) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!changed)</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			observersLocal = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.observers);</span><br><span class="line">			<span class="keyword">this</span>.changed=<span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (Observer obj : observersLocal) &#123;</span><br><span class="line">			obj.update();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">getUpdate</span><span class="params">(Observer obj)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.message;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//method to post message to the topic</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postMessage</span><span class="params">(String msg)</span></span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"Message Posted to Topic:"</span>+msg);</span><br><span class="line">		<span class="keyword">this</span>.message=msg;</span><br><span class="line">		<span class="keyword">this</span>.changed=<span class="keyword">true</span>;</span><br><span class="line">		notifyObservers();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The method implementation to register and unregister an observer is very simple, the extra method is <em>postMessage()</em> that will be used by client application to post String message to the topic. Notice the boolean variable to keep track of the change in the state of topic and used in notifying observers. This variable is required so that if there is no update and somebody calls <em>notifyObservers()</em> method, it doesn’t send false notifications to the observers.</p>
<p>Also notice the use of synchronization in <em>notifyObservers()</em> method to make sure the notification is sent only to the observers registered before the message is published to the topic.</p>
<p>Here is the implementation of Observers that will watch over the subject.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.observer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTopicSubscriber</span> <span class="keyword">implements</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> Subject topic;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MyTopicSubscriber</span><span class="params">(String nm)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.name=nm;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		String msg = (String) topic.getUpdate(<span class="keyword">this</span>);</span><br><span class="line">		<span class="keyword">if</span>(msg == <span class="keyword">null</span>)&#123;</span><br><span class="line">			System.out.println(name+<span class="string">":: No new message"</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span></span><br><span class="line">		System.out.println(name+<span class="string">":: Consuming message::"</span>+msg);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSubject</span><span class="params">(Subject sub)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.topic=sub;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Notice the implementation of <em>update()</em> method where it’s calling Subject <em>getUpdate()</em> method to get the message to consume. We could have avoided this call by passing message as argument to <em>update()</em> method.</p>
<p>Here is a simple test program to consume our topic implementation.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.observer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverPatternTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//create subject</span></span><br><span class="line">		MyTopic topic = <span class="keyword">new</span> MyTopic();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//create observers</span></span><br><span class="line">		Observer obj1 = <span class="keyword">new</span> MyTopicSubscriber(<span class="string">"Obj1"</span>);</span><br><span class="line">		Observer obj2 = <span class="keyword">new</span> MyTopicSubscriber(<span class="string">"Obj2"</span>);</span><br><span class="line">		Observer obj3 = <span class="keyword">new</span> MyTopicSubscriber(<span class="string">"Obj3"</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//register observers to the subject</span></span><br><span class="line">		topic.register(obj1);</span><br><span class="line">		topic.register(obj2);</span><br><span class="line">		topic.register(obj3);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//attach observer to subject</span></span><br><span class="line">		obj1.setSubject(topic);</span><br><span class="line">		obj2.setSubject(topic);</span><br><span class="line">		obj3.setSubject(topic);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//check if any update is available</span></span><br><span class="line">		obj1.update();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//now send message to subject</span></span><br><span class="line">		topic.postMessage(<span class="string">"New Message"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>When we run above program, we get following output.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Obj1:: No new message</span><br><span class="line">Message Posted to Topic:New Message</span><br><span class="line">Obj1:: Consuming message::New Message</span><br><span class="line">Obj2:: Consuming message::New Message</span><br><span class="line">Obj3:: Consuming message::New Message</span><br></pre></td></tr></table></figure></p>
<h3 id="Java-Observer-Pattern-Class-Diagram"><a href="#Java-Observer-Pattern-Class-Diagram" class="headerlink" title="Java Observer Pattern Class Diagram"></a>Java Observer Pattern Class Diagram</h3><p><img src="/images/2017/5/observer-pattern.png" alt="这里写图片描述"></p>
<p>Observer design pattern is also called as publish-subscribe pattern. Some of it’s implementations are;</p>
<ul>
<li>java.util.EventListener in Swing</li>
<li>javax.servlet.http.HttpSessionBindingListener</li>
<li>javax.servlet.http.HttpSessionAttributeListener</li>
</ul>
<hr>
<p>转载：<br><a href="http://www.journaldev.com/1739/observer-design-pattern-in-java" target="_blank" rel="noopener">journaldev</a></p>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/05/08/设计模式-备忘录模式/">设计模式:备忘录模式</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-05-08
        </span>
        
          <span class="post-category">
            
              <a href="/categories/软件工程/">软件工程</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h2 id="备忘录模式"><a href="#备忘录模式" class="headerlink" title="备忘录模式"></a>备忘录模式</h2><p>备忘录模式（Memento Pattern）保存一个对象的某个状态，以便在适当的时候恢复对象。备忘录模式属于行为型模式。</p>
<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><h4 id="意图"><a href="#意图" class="headerlink" title="意图"></a>意图</h4><p>在不破坏封装性的前提下，捕获一个对象的内部状态，并在该对象之外保存这个状态。</p>
<h4 id="主要解决"><a href="#主要解决" class="headerlink" title="主要解决"></a>主要解决</h4><p>所谓备忘录模式就是在不破坏封装的前提下，捕获一个对象的内部状态，并在该对象之外保存这个状态，这样可以在以后将对象恢复到原先保存的状态。</p>
<h4 id="何时使用"><a href="#何时使用" class="headerlink" title="何时使用"></a>何时使用</h4><p>很多时候我们总是需要记录一个对象的内部状态，这样做的目的就是为了允许用户取消不确定或者错误的操作，能够恢复到他原先的状态，使得他有”后悔药”可吃。</p>
<h4 id="如何解决"><a href="#如何解决" class="headerlink" title="如何解决"></a>如何解决</h4><p>通过一个备忘录类专门存储对象状态。</p>
<h4 id="关键代码"><a href="#关键代码" class="headerlink" title="关键代码"></a>关键代码</h4><p>客户不与备忘录类耦合，与备忘录管理类耦合。</p>
<h4 id="应用实例"><a href="#应用实例" class="headerlink" title="应用实例"></a>应用实例</h4><ol>
<li>后悔药</li>
<li>打游戏时的存档</li>
<li>Windows 里的 ctri + z</li>
<li>IE 中的后退</li>
<li>数据库的事务管理</li>
</ol>
<h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ol>
<li>给用户提供了一种可以恢复状态的机制，可以使用户能够比较方便地回到某个历史的状态。 </li>
<li>实现了信息的封装，使得用户不需要关心状态的保存细节。</li>
</ol>
<h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><p>消耗资源。如果类的成员变量过多，势必会占用比较大的资源，而且每一次保存都会消耗一定的内存。</p>
<h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><ol>
<li>需要保存/恢复数据的相关状态场景。 </li>
<li>提供一个可回滚的操作。</li>
</ol>
<h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><ol>
<li>为了符合迪米特原则，还要增加一个管理备忘录的类。 </li>
<li>为了节约内存，可使用原型模式+备忘录模式。</li>
</ol>
<h3 id="模式结构"><a href="#模式结构" class="headerlink" title="模式结构"></a>模式结构</h3><p>下图是备忘录模式的UML结构图：</p>
<p><img src="/images/2017/5/1.jpg" alt=""></p>
<p>在备忘录模式结构图中包含如下几个角色：</p>
<ul>
<li>Originator（原发器）：它是一个普通类，可以创建一个备忘录，并存储它的当前内部状态，也可以使用备忘录来恢复其内部状态，一般将需要保存内部状态的类设计为原发器。</li>
<li>Memento（备忘录)：存储原发器的内部状态，根据原发器来决定保存哪些内部状态。备忘录的设计一般可以参考原发器的设计，根据实际需要确定备忘录类中的属性。需要注意的是，除了原发器本身与负责人类之外，备忘录对象不能直接供其他类使用，原发器的设计在不同的编程语言中实现机制会有所不同。</li>
<li>Caretaker（负责人）：负责人又称为管理者，它负责保存备忘录，但是不能对备忘录的内容进行操作或检查。在负责人类中可以存储一个或多个备忘录对象，它只负责存储对象，而不能修改对象，也无须知道对象的实现细节。</li>
</ul>
<p>理解备忘录模式并不难，但关键在于如何设计备忘录类和负责人类。由于在备忘录中存储的是原发器的中间状态，因此需要防止原发器以外的其他对象访问备忘录，特别是不允许其他对象来修改备忘录。</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>备忘录模式使用三个类 Memento、Originator 和 CareTaker。Memento 包含了要被恢复的对象的状态。Originator 创建并在 Memento 对象中存储状态。Caretaker 对象负责从 Memento 中恢复对象的状态。<br>MementoPatternDemo，我们的演示类使用 CareTaker 和 Originator 对象来显示对象的状态恢复。</p>
<p><img src="http://www.runoob.com/wp-content/uploads/2014/08/memento_pattern_uml_diagram.jpg" alt=""></p>
<h4 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤 1"></a>步骤 1</h4><p>创建 Memento 类。<br>Memento.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Memento</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String state;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Memento</span><span class="params">(String state)</span></span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.state = state;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getState</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="步骤-2"><a href="#步骤-2" class="headerlink" title="步骤 2"></a>步骤 2</h4><p>创建 Originator 类。<br>Originator.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Originator</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String state;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(String state)</span></span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.state = state;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getState</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Memento <span class="title">saveStateToMemento</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Memento(state);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getStateFromMemento</span><span class="params">(Memento Memento)</span></span>&#123;</span><br><span class="line">      state = Memento.getState();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="步骤-3"><a href="#步骤-3" class="headerlink" title="步骤 3"></a>步骤 3</h4><p>创建 CareTaker 类。<br>CareTaker.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CareTaker</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> List&lt;Memento&gt; mementoList = <span class="keyword">new</span> ArrayList&lt;Memento&gt;();</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Memento state)</span></span>&#123;</span><br><span class="line">      mementoList.add(state);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Memento <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span></span>&#123;</span><br><span class="line">      <span class="keyword">return</span> mementoList.get(index);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="步骤-4"><a href="#步骤-4" class="headerlink" title="步骤 4"></a>步骤 4</h4><p>使用 CareTaker 和 Originator 对象。<br>MementoPatternDemo.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MementoPatternDemo</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      Originator originator = <span class="keyword">new</span> Originator();</span><br><span class="line">      CareTaker careTaker = <span class="keyword">new</span> CareTaker();</span><br><span class="line">      originator.setState(<span class="string">"State #1"</span>);</span><br><span class="line">      originator.setState(<span class="string">"State #2"</span>);</span><br><span class="line">      careTaker.add(originator.saveStateToMemento());</span><br><span class="line">      originator.setState(<span class="string">"State #3"</span>);</span><br><span class="line">      careTaker.add(originator.saveStateToMemento());</span><br><span class="line">      originator.setState(<span class="string">"State #4"</span>);</span><br><span class="line"></span><br><span class="line">      System.out.println(<span class="string">"Current State: "</span> + originator.getState());		</span><br><span class="line">      originator.getStateFromMemento(careTaker.get(<span class="number">0</span>));</span><br><span class="line">      System.out.println(<span class="string">"First saved State: "</span> + originator.getState());</span><br><span class="line">      originator.getStateFromMemento(careTaker.get(<span class="number">1</span>));</span><br><span class="line">      System.out.println(<span class="string">"Second saved State: "</span> + originator.getState());</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>步骤 5<br>验证输出。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Current State: State #4</span><br><span class="line">First saved State: State #2</span><br><span class="line">Second saved State: State #3</span><br></pre></td></tr></table></figure></p>
<hr>
<p>参考资料:</p>
<ol>
<li><a href="http://www.runoob.com/design-pattern/memento-pattern.html" target="_blank" rel="noopener">菜鸟教程</a></li>
<li><a href="https://quanke.gitbooks.io/design-pattern-java/%E6%92%A4%E9%94%80%E5%8A%9F%E8%83%BD%E7%9A%84%E5%AE%9E%E7%8E%B0%E2%80%94%E2%80%94%E5%A4%87%E5%BF%98%E5%BD%95%E6%A8%A1%E5%BC%8F%EF%BC%88%E4%BA%8C%EF%BC%89.html" target="_blank" rel="noopener">quanke.gitbooks.io</a></li>
</ol>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/05/03/设计模式-中介者模式/">设计模式:中介者模式</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-05-03
        </span>
        
          <span class="post-category">
            
              <a href="/categories/软件工程/">软件工程</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>转载自：<br>作者： <a href="http://www.cnblogs.com/chenssy/p/3348520.html" target="_blank" rel="noopener">chenssy</a> </p>
<hr>
<h2 id="中介者模式"><a href="#中介者模式" class="headerlink" title="中介者模式"></a>中介者模式</h2><p>在我们的生活中处处充斥着“中介者”，比如你租房、买房、出国留学、找工作、旅游等等可能都需要那些中介者的帮助，同时我们也深受其害，高昂的中介费，虚假信息。在地球上最大的中介者就是联合国了，它主要用来维护国际和平与安全、解决国际间经济、社会、文化和人道主义性质的问题。国与国之间的关系异常复杂，会因为各种各样的利益关系来结成盟友或者敌人，熟话说没有永远的朋友，也没有永远的敌人，只有永远的利益！所以国与国之间的关系同样会随着时间、环境因为利益而发生改变。在我们软件的世界也同样如此，对象与对象之间存在着很强、复杂的关联关系，如果没有类似于联合国这样的“机构”会很容易出问题的，譬如：</p>
<ol>
<li>对象与对象之间存在大量的关联关系，这样势必会<strong>导致系统的结构变得很复杂</strong>，同时若一个对象发生改变，我们也需要跟踪与之相关联的对象，同时做出相应的处理。</li>
<li>对象之间的连接增加会导致<strong>对象可复用性降低</strong>。</li>
<li><strong>系统的可扩展性低</strong>。增加一个新的对象，我们需要在其相关连的对象上面加上引用，这样就会导致系统的耦合性增高，使系统的灵活性和可扩展都降低。</li>
</ol>
<p>在前面我就知道如果两个类不必彼此通信，那么这两个类就不应当发生直接关联的关系。如果其中一个类需要调用另一个类中的方法，我们可以通过第三方来转发这个调用。所以对于关系比较复杂的系统，我们为了减少对象之间的关联关系，使之成为一个松耦合系统，我们就需要使用中介者模式。</p>
<p>通过中介者模式，我们可以将复杂关系的网状结构变成结构简单的以中介者为核心的星形结构，每个对象不再和它与之关联的对象直接发生相互作用，而是通过中介者对象来另一个对象发生相互作用。</p>
<p><img src="http://images.cnitblog.com/blog/381060/201310/01151529-0027d98f7c304706bd85a53e3deb597f.jpg" alt=""> </p>
<h3 id="模式定义"><a href="#模式定义" class="headerlink" title="模式定义"></a>模式定义</h3><p><strong> 所谓中介者模式就是用一个中介对象来封装一系列的对象交互，中介者使各对象不需要显式地相互引用，从而使其耦合松散，而且可以独立地改变它们之间的交互。</strong></p>
<p>通过定义我们可以看出中介者主要是通过中介对象来封装对象之间的关系，使之各个对象在不需要知道其他对象的具体信息情况下通过中介者对象来与之通信。同时通过引用中介者对象来减少系统对象之间关系，提高了对象的可复用和系统的可扩展性。</p>
<p>但是就是因为中介者对象封装了对象之间的关联关系，导致中介者对象变得比较庞大，所承担的责任也比较多。它需要知道每个对象和他们之间的交互细节，如果它出问题，将会导致整个系统都会出问题。所以它比较容易应用也很容易误用。<strong>故当系统中出现了“多对多”交互复杂的关系群时，千万别急着使用中介者模式，你首先需要做的就是反思你的系统在设计上是不是合理。</strong></p>
<h3 id="模式结构"><a href="#模式结构" class="headerlink" title="模式结构"></a>模式结构</h3><p>下图是中介者模式的UML结构图：<br><img src="http://images.cnitblog.com/blog/381060/201310/01151530-1b6531f07e8f4ec6b66a5cc9da0f776b.png" alt=""><br>它主要包含如下几个角色：</p>
<ul>
<li>Mediator: 抽象中介者。定义了同事对象到中介者对象之间的接口。</li>
<li>ConcreteMediator: 具体中介者。实现抽象中介者的方法，它需要知道所有的具体同事类，同时需要从具体的同事类那里接收信息，并且向具体的同事类发送信息。</li>
<li>Colleague: 抽象同事类。</li>
<li>ConcreteColleague: 具体同事类。每个具体同事类都只需要知道自己的行为即可，但是他们都需要认识中介者。</li>
</ul>
<p>在中介者模式中中介者对象处于核心地位，因为它定义了整个系统中所有具体同事类之间的关系。在整个系统中它主要承担两个方面的责任。</p>
<ol>
<li>结构上起到中转作用。通过中介者对象对关系的封装，使得具体的同事类不再需要显示的引用其他对象，它只需要通过中介者就可以完成与其他同事类之间的通信。</li>
<li>行为上起到协作作用。中介者对同事类之间的关系进行封装，同事类在不需要知道其他对象的情况下通过中介者与其他对象完成通信。在这个过程中同事类是不需要指明中介者该如何做，中介者可以根据自身的逻辑来进行协调，对同事的请求进一步处理，将同事成员之间的关系行为进行分离和封装。</li>
</ol>
<p>同时由于中介者对对象的关系进行了封装，使得各个同事类之间的耦合减少了，使得他们可以独立改变和复用。</p>
<h3 id="模式实现"><a href="#模式实现" class="headerlink" title="模式实现"></a>模式实现</h3><p>这里我们就以租房为例，这里中介机构充当租房者与房屋所有者之间的中介者。UML结构图：<br><img src="http://images.cnitblog.com/blog/381060/201310/01151534-adb283c3d5744d5f9a1af6b8af3b7d18.png" alt=""><br>首先是抽象中介者:Mediator.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Mediator</span> </span>&#123;</span><br><span class="line">    <span class="comment">//申明一个联络方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">constact</span><span class="params">(String message,Person person)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后是抽象同事对象:Person.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> String name;</span><br><span class="line">    <span class="keyword">protected</span> Mediator mediator;</span><br><span class="line">    </span><br><span class="line">    Person(String name,Mediator mediator)&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.mediator = mediator;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>两个具体同事类：HouseOwner.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HouseOwner</span> <span class="keyword">extends</span> <span class="title">Person</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    HouseOwner(String name, Mediator mediator) &#123;</span><br><span class="line">        <span class="keyword">super</span>(name, mediator);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@desc</span> 与中介者联系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">constact</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        mediator.constact(message, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@desc</span> 获取信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getMessage</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"房主:"</span> + name +<span class="string">",获得信息："</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Tenant.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tenant</span> <span class="keyword">extends</span> <span class="title">Person</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    Tenant(String name, Mediator mediator) &#123;</span><br><span class="line">        <span class="keyword">super</span>(name, mediator);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@desc</span> 与中介者联系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">constact</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        mediator.constact(message, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@desc</span> 获取信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getMessage</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"租房者:"</span> + name +<span class="string">",获得信息："</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体中介者对象：中介机构、MediatorStructure.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MediatorStructure</span> <span class="keyword">extends</span> <span class="title">Mediator</span></span>&#123;</span><br><span class="line">    <span class="comment">//首先中介机构必须知道所有房主和租房者的信息</span></span><br><span class="line">    <span class="keyword">private</span> HouseOwner houseOwner;</span><br><span class="line">    <span class="keyword">private</span> Tenant tenant;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HouseOwner <span class="title">getHouseOwner</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> houseOwner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHouseOwner</span><span class="params">(HouseOwner houseOwner)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.houseOwner = houseOwner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Tenant <span class="title">getTenant</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tenant;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTenant</span><span class="params">(Tenant tenant)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.tenant = tenant;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">constact</span><span class="params">(String message, Person person)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(person == houseOwner)&#123;          <span class="comment">//如果是房主，则租房者获得信息</span></span><br><span class="line">            tenant.getMessage(message);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;       <span class="comment">//否则则是房主获得信息</span></span><br><span class="line">            houseOwner.getMessage(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客户端：Client.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//一个房主、一个租房者、一个中介机构</span></span><br><span class="line">        MediatorStructure mediator = <span class="keyword">new</span> MediatorStructure();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//房主和租房者只需要知道中介机构即可</span></span><br><span class="line">        HouseOwner houseOwner = <span class="keyword">new</span> HouseOwner(<span class="string">"张三"</span>, mediator);</span><br><span class="line">        Tenant tenant = <span class="keyword">new</span> Tenant(<span class="string">"李四"</span>, mediator);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//中介结构要知道房主和租房者</span></span><br><span class="line">        mediator.setHouseOwner(houseOwner);</span><br><span class="line">        mediator.setTenant(tenant);</span><br><span class="line">        </span><br><span class="line">        tenant.constact(<span class="string">"听说你那里有三室的房主出租....."</span>);</span><br><span class="line">        houseOwner.constact(<span class="string">"是的!请问你需要租吗?"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">房主:张三,获得信息：听说你那里有三室的房主出租..... </span><br><span class="line">租房者:李四,获得信息：是的!请问你需要租吗?</span><br></pre></td></tr></table></figure></p>
<h3 id="模式适用场景"><a href="#模式适用场景" class="headerlink" title="模式适用场景"></a>模式适用场景</h3><ol>
<li>系统中对象之间存在比较复杂的引用关系，导致他们之间的依赖关系结构混乱而且难以复用该对象。</li>
<li>想通过一个中间类来封装多个类中的行为，而又不想生成太多的子类。</li>
</ol>
<h3 id="模式总结"><a href="#模式总结" class="headerlink" title="模式总结"></a>模式总结</h3><ol>
<li>在中介者模式中通过引用中介者对象，将系统中有关的对象所引用的其他对象数目减少到最少。它简化了系统的结构，将系统由负责的网状结构转变成简单的星形结构，中介者对象在这里起到中转和协调作用。</li>
<li>中介者类是中介者模式的核心，它对整个系统进行控制和协调，简化了对象之间的交互，还可以对对象间的交互进行进一步的控制。</li>
<li>通过使用中介者模式，具体的同事类可以独立变化，通过引用中介者可以简化同事类的设计和实现。</li>
<li>就是由于中介者对象需要知道所有的具体同事类，封装具体同事类之间相互关系，导致中介者对象变得非常复杂，系统维护起来较为困难。</li>
</ol>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/04/27/设计模式-迭代器模式/">设计模式:迭代器模式</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-04-27
        </span>
        
          <span class="post-category">
            
              <a href="/categories/软件工程/">软件工程</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h2 id="迭代器模式"><a href="#迭代器模式" class="headerlink" title="迭代器模式"></a>迭代器模式</h2><p>迭代器模式（Iterator Pattern）是 Java 和 .Net 编程环境中非常常用的设计模式。这种模式用于顺序访问集合对象的元素，不需要知道集合对象的底层表示。<br>迭代器模式属于行为型模式。</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>我们将创建一个叙述导航方法的 <em>Iterator</em> 接口和一个返回迭代器的 <em>Container</em> 接口。实现了 <em>Container</em> 接口的实体类将负责实现 <em>Iterator</em> 接口。<br><em>IteratorPatternDemo</em>，我们的演示类使用实体类 <em>NamesRepository</em> 来打印 <em>NamesRepository</em> 中存储为集合的 <em>Names</em>。<br><img src="http://www.runoob.com/wp-content/uploads/2014/08/iterator_pattern_uml_diagram.jpg" alt=""> </p>
<h4 id="步骤1"><a href="#步骤1" class="headerlink" title="步骤1"></a>步骤1</h4><p>创建接口。<br><em>Iterator.java</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Iterator</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span></span>;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">next</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><em>Container.java</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Container</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> Iterator <span class="title">getIterator</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="步骤2"><a href="#步骤2" class="headerlink" title="步骤2"></a>步骤2</h4><p>创建实现了 <em>Container</em> 接口的实体类。该类有实现了 <em>Iterator</em> 接口的内部类 <em>NameIterator</em>。<br><em>NameRepository.java</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NameRepository</span> <span class="keyword">implements</span> <span class="title">Container</span> </span>&#123;</span><br><span class="line">   <span class="keyword">public</span> String names[] = &#123;<span class="string">"Robert"</span> , <span class="string">"John"</span> ,<span class="string">"Julie"</span> , <span class="string">"Lora"</span>&#125;;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Iterator <span class="title">getIterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> NameIterator();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">NameIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">int</span> index;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">if</span>(index &lt; names.length)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Object <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">if</span>(<span class="keyword">this</span>.hasNext())&#123;</span><br><span class="line">            <span class="keyword">return</span> names[index++];</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;		</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="步骤3"><a href="#步骤3" class="headerlink" title="步骤3"></a>步骤3</h4><p>使用 <em>NameRepository</em> 来获取迭代器，并打印名字。<br><em>IteratorPatternDemo.java</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IteratorPatternDemo</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      NameRepository namesRepository = <span class="keyword">new</span> NameRepository();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span>(Iterator iter = namesRepository.getIterator(); iter.hasNext();)&#123;</span><br><span class="line">         String name = (String)iter.next();</span><br><span class="line">         System.out.println(<span class="string">"Name : "</span> + name);</span><br><span class="line">      &#125; 	</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="步骤-4"><a href="#步骤-4" class="headerlink" title="步骤 4"></a>步骤 4</h4><p>验证输出。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Name : Robert</span><br><span class="line">Name : John</span><br><span class="line">Name : Julie</span><br><span class="line">Name : Lora</span><br></pre></td></tr></table></figure></p>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ol>
<li>访问一个聚合对象的内容而无须暴露它的内部表示。</li>
<li>需要为聚合对象提供多种遍历方式。</li>
<li>为遍历不同的聚合结构提供一个统一的接口。</li>
</ol>
<h3 id="模式总结"><a href="#模式总结" class="headerlink" title="模式总结"></a>模式总结</h3><ol>
<li>迭代器模式提供一种方法来访问聚合对象，而不用暴露这个对象的内部表示。</li>
<li>将遍历聚合对象中数据的行为提取出来，封装到一个迭代器中，通过专门的迭代器来遍历聚合对象的内部数据，这就是迭代器模式的本质。迭代器模式是“单一职责原则”的完美体现。</li>
<li>当使用迭代器的时候，我们依赖聚合提供遍历。</li>
<li>迭代器提供了一个通用的接口，让我们遍历聚合的项，放我们编码使用聚合项时，就可以使用多态机制。</li>
</ol>
<hr>
<p>参考资料：</p>
<ol>
<li><a href="http://www.runoob.com/design-pattern/iterator-pattern.html" target="_blank" rel="noopener">菜鸟教程</a></li>
<li><a href="http://www.cnblogs.com/chenssy/p/3250409.html" target="_blank" rel="noopener">chenssy</a> </li>
</ol>

        
      
    </div>

    

    

  </article>

      
      
  <nav class="pagination">
    
      <a class="prev" href="/page/7/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text">上一页</span>
      </a>
    
    
      <a class="next" href="/page/9/">
        <span class="next-text">下一页</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


    
  </section>

          </div>
          

        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:liujunming1163@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/liujunming" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>



<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2016 - 
    
    2018

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">liujunming</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    


    
  



  
  





  
    <script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

  
    <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.10.1"></script>

  </body>
</html>
