<!DOCTYPE html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.9.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="中断基本概念的建立">




  <meta name="keywords" content="中断, L">










  <link rel="alternate" href="/atom.xml" title="L">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.10.1">



<link rel="canonical" href="http://liujunming.github.io/2019/08/17/中断基本概念的建立/">



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css">




  <link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css">



<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.10.1">



  



  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>









<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":true};
</script>

    <title> 中断基本概念的建立 - L </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">L</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/categories">
        <li class="mobile-menu-item">
          
          
            分类
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            标签
          
        </li>
      </a>
    
      <a href="/links">
        <li class="mobile-menu-item">
          
          
            Links
          
        </li>
      </a>
    
      <a href="/books">
        <li class="mobile-menu-item">
          
          
            Books
          
        </li>
      </a>
    
      <a href="/course">
        <li class="mobile-menu-item">
          
          
            Course
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">L</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            
            
              分类
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/links">
            
            
              Links
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/books">
            
            
              Books
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/course">
            
            
              Course
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          中断基本概念的建立
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-08-17
        </span>
        
          <span class="post-category">
            
              <a href="/categories/中断/">中断</a>
            
          </span>
        
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-PIC"><span class="toc-text">1. PIC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-APIC"><span class="toc-text">2. APIC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-MSI"><span class="toc-text">3. MSI</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-What-are-MSIs"><span class="toc-text">3.1 What are MSIs?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Why-use-MSIs"><span class="toc-text">3.2 Why use MSIs?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-misc"><span class="toc-text">3.3 misc</span></a></li></ol></li></ol>
    </div>
  </div>



    <div class="post-content">
      
        <p>本文将介绍PCI、APIC、MSI基本概念。<a id="more"></a></p>
<p>中断从设备发送到CPU需要“可编程中断控制器”的转发(MSI除外)。中断控制器发展至今，经历了PIC和APIC两个阶段。</p>
<h2 id="1-PIC"><a href="#1-PIC" class="headerlink" title="1. PIC"></a>1. PIC</h2><p>也就是8259A芯片。PIC的相关介绍参见<a href="https://book.douban.com/subject/3619896/" target="_blank" rel="noopener">系统虚拟化</a>2.4.1章节。</p>
<p>明白PIC中重要的寄存器以及PIC向CPU递交中断的流程即可。若想深究，可以参见<a href="https://pdos.csail.mit.edu/6.828/2005/readings/hardware/8259A.pdf" target="_blank" rel="noopener">8259A Programmable Interrupt Controller
</a></p>
<h2 id="2-APIC"><a href="#2-APIC" class="headerlink" title="2. APIC"></a>2. APIC</h2><p>PIC可以在UP(单处理器)平台上工作，但无法用于MP(多处理器)平台。为此，APIC应运而生。</p>
<p><img src="/images/2019/8/9.png" alt><br>APIC的相关介绍参见<a href="https://book.douban.com/subject/3619896/" target="_blank" rel="noopener">系统虚拟化</a>2.4.1章节。</p>
<p>APIC的发展历程：<br>APIC-&gt;xAPIC-&gt;x2APIC</p>
<p>LAPIC处理的中断类型有如下三种：</p>
<ul>
<li>Local interrupt - configured by local vector table(LVT)</li>
<li>External interrupt - from IOAPIC/MSI</li>
<li>inter-processor interrupt(IPI) - configured by interrupt command register(ICR)</li>
</ul>
<p>详细内容请参见SDM(ADVANCED PROGRAMMABLE INTERRUPT CONTROLLER)部分。</p>
<h2 id="3-MSI"><a href="#3-MSI" class="headerlink" title="3. MSI"></a>3. MSI</h2><h3 id="3-1-What-are-MSIs"><a href="#3-1-What-are-MSIs" class="headerlink" title="3.1 What are MSIs?"></a>3.1 What are MSIs?</h3><p>A Message Signaled Interrupt is a write from the device to a special address which causes an interrupt to be received by the CPU.</p>
<p>The MSI capability was first specified in PCI 2.2 and was later enhanced in PCI 3.0 to allow each interrupt to be masked individually.  The MSI-X capability was also introduced with PCI 3.0.  It supports more interrupts per device than MSI and allows interrupts to be independently configured.</p>
<h3 id="3-2-Why-use-MSIs"><a href="#3-2-Why-use-MSIs" class="headerlink" title="3.2 Why use MSIs?"></a>3.2 Why use MSIs?</h3><p>There are three reasons why using MSIs can give an advantage over traditional pin-based interrupts.</p>
<ol>
<li><p>Pin-based PCI interrupts are often shared amongst several devices. To support this, the kernel must call each interrupt handler associated with an interrupt, which leads to reduced performance for the system as a whole.  MSIs are never shared, so this problem cannot arise. <a href="http://liujunming.top/2018/12/04/Understanding-the-Linux-Kernel-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0-Interrupts-and-Exceptions/" target="_blank" rel="noopener">for detail</a></p>
</li>
<li><p>When a device writes data to memory, then raises a pin-based interrupt, it is possible that the interrupt may arrive before all the data has arrived in memory (this becomes more likely with devices behind PCI-PCI bridges).  In order to ensure that all the data has arrived in memory, the interrupt handler must read a register on the device which raised the interrupt.  PCI transaction ordering rules require that all the data arrive in memory before the value may be returned from the register. Using MSIs avoids this problem as the interrupt-generating write cannot pass the data writes, so by the time the interrupt is raised, the driver knows that all the data has arrived in memory.</p>
</li>
<li><p>PCI devices can only support a single pin-based interrupt per function. Often drivers have to query the device to find out what event has occurred, slowing down interrupt handling for the common case.  With MSIs, a device can support more interrupts, allowing each interrupt to be specialised to a different purpose.  </p>
</li>
</ol>
<h3 id="3-3-misc"><a href="#3-3-misc" class="headerlink" title="3.3 misc"></a>3.3 misc</h3><p>intel系统中，MSI允许PCI设备直接发送中断到LAPIC，不需要通过IOAPIC。</p>
<p>MSI allows the device to write a small amount of interrupt-describing data to a special memory-mapped I/O address, and the chipset then delivers the corresponding interrupt to a processor.</p>
<p>A common misconception with MSI is that it allows the device to send data to a processor as part of the interrupt. The data that is sent as part of the memory write transaction is used by the chipset to determine which interrupt to trigger on which processor; that data is not available for the device to communicate additional information to the interrupt handler.</p>
<p>On Intel systems, the LAPIC must be enabled for the PCI (and PCI Express) MSI/MSI-X to work, even on uniprocessor (single core) systems. In these systems, MSIs are handled by writing the interrupt vector directly into the LAPIC of the processor/core that needs to service the interrupt.</p>
<p>详细内容请参见SDM(MESSAGE SIGNALLED INTERRUPTS)部分。</p>
<hr>
<p>参考资料：</p>
<ol>
<li><a href="https://elixir.bootlin.com/linux/v5.3-rc4/source/Documentation/PCI/msi-howto.rst" target="_blank" rel="noopener">msi kernel document</a></li>
<li><a href="https://en.wikipedia.org/wiki/Message_Signaled_Interrupts" target="_blank" rel="noopener">msi wikipedia</a></li>
<li><a href="https://www.binss.me/blog/what-is-apic/" target="_blank" rel="noopener">APIC的那些事儿</a></li>
<li><a href="https://github.com/GiantVM/doc/tree/master/interrupt_and_io" target="_blank" rel="noopener">interrupt_and_io</a></li>
</ol>

      
    </div>

    
      
      



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/中断/">中断</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2019/08/20/acrn-kernel那些事/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">acrn-kernel那些事</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2019/08/17/中断那些事/">
        <span class="next-text nav-default">中断那些事</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:liujunming1163@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/liujunming" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>



<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2016 - 
    
    2021

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">liujunming</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://liujunming.github.io/2019/08/17/中断基本概念的建立/';
        this.page.identifier = '2019/08/17/中断基本概念的建立/';
        this.page.title = '中断基本概念的建立';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//http-liujunming-top-2.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script>

  

  



    
  



  
  





  
    <script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

  
    <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.10.1"></script>

  </body>
</html>
